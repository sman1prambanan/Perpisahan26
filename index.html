<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pendataan Promnight</title>

<!-- GOOGLE FONT -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- SWEETALERT 2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- LOTTIE -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<!-- CONFETTI -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #1e1f26, #3f3351, #864879);
    background-size: 400% 400%;
    animation: gradientMove 12s ease infinite;
    padding: 40px;
    color: #fff;
}

@keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.container {
    max-width: 400px;
    margin: auto;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    padding: 25px;
    border-radius: 15px;
    animation: fadeIn .8s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    margin-top: 8px;
    outline: none;
    font-size: 15px;
    background: rgba(255,255,255,0.85);
}

button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    margin-top: 15px;
    cursor: pointer;
    font-size: 16px;
    color: #fff;
    font-weight: 600;
    transition: .3s ease;
    background: #ff8fa3;
}

button:hover {
    background: #ff6f91;
    transform: translateY(-2px);
}

#step3 button:first-child { background: #7fd18b; }
#step3 button:last-child { background: #d46a6a; }

.hidden { display: none; }

#loading {
    text-align:center; 
    margin-top:20px;
}
</style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">Pendataan Promnight</h2>

    <!-- STEP 1 -->
    <div id="step1">
        <label>Masukkan NIS:</label>
        <input type="text" id="nis" placeholder="Masukan NIS">
        <button onclick="checkNIS()">Cek NIS</button>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="hidden">
        <h3>Data Ditemukan</h3>
        <p><strong>Nama:</strong> <span id="nama"></span></p>
        <p><strong>Kelas:</strong> <span id="kelas"></span></p>
        <button onclick="gotoStep3()">Lanjutkan</button>
    </div>

    <!-- STEP 3 -->
    <div id="step3" class="hidden">
        <h3>Konfirmasi Kehadiran</h3>
        <button onclick="submitData('Mengikuti')">Saya Mengikuti</button>
        <button onclick="submitData('Tidak Mengikuti')">Tidak Mengikuti</button>
    </div>

    <div id="done" class="hidden">
        <h3>Terima Kasih!</h3>
        <p>Data Anda berhasil dikirim ðŸŽ‰</p>
    </div>

    <!-- LOADING -->
    <div id="loading" class="hidden">
        <lottie-player 
            src="https://assets10.lottiefiles.com/packages/lf20_usmfx6bp.json"
            background="transparent"
            speed="1"
            style="width:100px; height:100px; margin:auto;"
            loop
            autoplay>
        </lottie-player>
        <p>Memproses...</p>
    </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzIYOzT9zwcDsvpkH5z6VgUKXDrFrP3Cqf2XHXYN98JAJ_buIUPYBYH-QYeDrR-quCWFw/exec";

let globalData = {};

// SHOW / HIDE LOADING
function showLoading(show) {
    const load = document.getElementById("loading");
    if (show) load.classList.remove("hidden");
    else load.classList.add("hidden");
}

// POPUP LOTTIE
function lottieAlert(title, msg, animURL) {
    Swal.fire({
        title: title,
        html: `
            <lottie-player 
                src="${animURL}"
                background="transparent"
                speed="1"
                style="width: 150px; height: 150px; margin:auto;"
                autoplay>
            </lottie-player>
            <p style="margin-top:10px;">${msg}</p>
        `,
        showConfirmButton: true,
        confirmButtonText: "OK",
        width: 350,
    });
}

// CEK NIS
function checkNIS() {
    const nis = document.getElementById("nis").value;
    if (!nis) {
        return lottieAlert(
            "NIS Kosong!",
            "Masukkan NIS terlebih dahulu.",
            "https://assets10.lottiefiles.com/packages/lf20_t24tpvcu.json"
        );
    }

    showLoading(true);

    fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ action:"checkNIS", nis })
    })
    .then(res => res.json())
    .then(data => {
        showLoading(false);

        if (data.status === "valid") {
            lottieAlert(
                "Data Ditemukan!",
                "Silakan lanjutkan ke langkah berikutnya.",
                "https://assets2.lottiefiles.com/packages/lf20_jbrw3hcz.json"
            );

            globalData = data;
            document.getElementById("step1").classList.add("hidden");
            document.getElementById("step2").classList.remove("hidden");
            document.getElementById("nama").innerText = data.nama;
            document.getElementById("kelas").innerText = data.kelas;
        } else if(data.status === "already"){
            Swal.fire({
                title: "NIS Sudah Submit!",
                html: `
                    <lottie-player 
                        src="https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json"
                        background="transparent"
                        speed="1"
                        style="width: 150px; height: 150px; margin:auto;"
                        autoplay>
                    </lottie-player>
                    <p style="margin-top:10px;">Anda sudah mengirim data sebelumnya.<br>Untuk mengulang data, hubungi admin via WhatsApp.</p>
                `,
                showCancelButton: true,
                confirmButtonText: "Hubungi Admin",
                cancelButtonText: "Tutup",
                width: 350
            }).then(result => {
                if(result.isConfirmed){
                    window.open("https://wa.me/6281392375768", "_blank");
                }
            });
        } else {
            lottieAlert(
                "NIS Tidak Terdaftar!",
                "Periksa kembali NIS yang Anda masukkan.",
                "https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json"
            );
        }
    })
    .catch(err => {
        showLoading(false);
        lottieAlert("Error!", "Terjadi kesalahan, coba lagi.", "https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json");
    });
}

// STEP 2 â†’ STEP 3
function gotoStep3() {
    document.getElementById("step2").classList.add("hidden");
    document.getElementById("step3").classList.remove("hidden");
}

// SUBMIT DATA
function submitData(status) {

    Swal.fire({
        title: "Apakah Anda yakin?",
        html: `
            <lottie-player 
                src="https://assets2.lottiefiles.com/packages/lf20_jbrw3hcz.json"
                background="transparent"
                speed="1"
                style="width: 150px; height: 150px; margin:auto;"
                autoplay>
            </lottie-player>
            <p style="margin-top:10px;">Anda memilih: <strong>${status}</strong></p>
        `,
        showCancelButton: true,
        confirmButtonText: "Ya, Kirim!",
        cancelButtonText: "Batal",
        width: 350
    }).then(result => {
        if (result.isConfirmed) {
            showLoading(true);

            fetch(scriptURL, {
                method: "POST",
                body: JSON.stringify({
                    action:"submitData",
                    nis: document.getElementById("nis").value,
                    nama: globalData.nama,
                    kelas: globalData.kelas,
                    mengikuti: status
                })
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);

                if (data.status === "success") {
                    confetti({ particleCount: 180, spread: 70, origin: { y: 0.6 } });
                    Swal.fire({
                        title: "Berhasil!",
                        html: `
                            <lottie-player 
                                src="https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json"
                                background="transparent"
                                speed="1"
                                style="width: 150px; height: 150px; margin:auto;"
                                autoplay>
                            </lottie-player>
                            <p style="margin-top:10px;">Data Anda berhasil dikirim. Jika Ada Informasi Yang Masih Di tanyakan Silahkan Klik Hubungi Admin!</p>
                        `,
                        showCancelButton: true,
                        confirmButtonText: "Hubungi Admin",
                        cancelButtonText: "Tutup",
                        width: 350
                    }).then(result => {
                        if(result.isConfirmed){
                            window.open("https://wa.me/6281392375768", "_blank");
                        }
                        confirmButtonText: "OK"
                    });
                    document.getElementById("step3").classList.add("hidden");
                    document.getElementById("done").classList.remove("hidden");
                } else if(data.status === "already"){
                    Swal.fire({
                        title: "Gagal!",
                        html: `
                            <lottie-player 
                                src="https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json"
                                background="transparent"
                                speed="1"
                                style="width: 150px; height: 150px; margin:auto;"
                                autoplay>
                            </lottie-player>
                            <p style="margin-top:10px;">NIS ini sudah mengirim data sebelumnya.<br>Untuk Mengulang Data, hubungi Admin via WhatsApp.</p>
                        `,
                        showCancelButton: true,
                        confirmButtonText: "Hubungi Admin",
                        cancelButtonText: "Tutup",
                        width: 350
                    }).then(result => {
                        if(result.isConfirmed){
                            window.open("https://wa.me/6281392375768", "_blank");
                        }
                    });
                }
            })
            .catch(err => {
                showLoading(false);
                lottieAlert("Error!", "Gagal mengirim data.", "https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json");
            });
        }
    });
}
</script>

</body>
</html>
